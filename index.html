<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Socket.IO Chat</title>
    <style>
      /* Same CSS as provided */
    </style>
  </head>
  <body>
    <ul id="messages"></ul>
    <form id="form" action="">
      <input id="input" autocomplete="off" placeholder="Type your message here..." /><button>
        Send
      </button>
    </form>
    <button id="start">Start Recording</button>
    <button id="stop" disabled>Stop Recording</button>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
   
    <script>
      const socket = io()

      const form = document.getElementById("form")
      const input = document.getElementById("input")
      const messages = document.getElementById("messages")
      const startButton = document.getElementById("start")
      const stopButton = document.getElementById("stop")

      let allowed = false
      let allowAccess
      let name = ""
      let mediaRecorder
      let audioStream
      let audioChunks = []
      let recordingInterval

      while (!name) {
        name = prompt("Please enter your name:")
      }

      socket.emit("user joined", name)

      form.addEventListener("submit", (e) => {
        e.preventDefault()
        if (input.value) {
          socket.emit("chat message", { name: name, message: input.value })
          input.value = ""
        }
      })

      socket.on("chat message", (data) => {
        const item = document.createElement("li")
        const messageContent = document.createElement("span")
        messageContent.innerHTML = `<strong>${data.name}</strong>: ${data.message}`
        item.appendChild(messageContent)
        messages.appendChild(item)
        messages.scrollTop = messages.scrollHeight
      })

      startButton.addEventListener("click", async () => {
        try {
          if (!allowed) {
            allowAccess = confirm("Do you want to allow access to your microphone and speaker?")
            allowed = allowAccess
          }
          if (allowed) {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true })
            audioStream = stream
            
            startRecordingLoop()
            
            startButton.disabled = true
            stopButton.disabled = false
            socket.emit("chat message", { name: name, message: "Recording audio..." })
          }
        } catch (err) {
          console.error("Error accessing microphone:", err)
        }
      })

      stopButton.addEventListener("click", () => {
        clearInterval(recordingInterval)
        stopRecording()
        startButton.disabled = false
        stopButton.disabled = true
        socket.emit("chat message", { name: name, message: "Stopped recording audio." })
      })

      function startRecordingLoop() {
        startRecording(audioStream)
        recordingInterval = setInterval(() => {
          stopRecording()
          setTimeout(() => {
            startRecording(audioStream)
          }, 0)
        }, 5000)
      }

      function startRecording(stream) {
        mediaRecorder = new MediaRecorder(stream, { mimeType: "audio/webm" })
        mediaRecorder.ondataavailable = handleDataAvailable
        mediaRecorder.start()
      }

      function handleDataAvailable(event) {
        if (event.data.size > 0) {
          const audioBlob = new Blob([event.data], { type: "audio/webm" })
          socket.emit("audio", audioBlob)
        }
      }

      function stopRecording() {
        if (mediaRecorder && mediaRecorder.state !== "inactive") {
          mediaRecorder.stop()
        }
      }

      socket.on("audio", async (data) => {
        console.log("Audio received")
        try {
          const binaryData = atob(data)
          const bytes = new Uint8Array(binaryData.length)
          for (let i = 0; i < binaryData.length; i++) {
            bytes[i] = binaryData.charCodeAt(i)
          }
          const audioBlob = new Blob([bytes], { type: "audio/webm" })
          const audioUrl = URL.createObjectURL(audioBlob)
          await playAudio(audioUrl)
        } catch (e) {
          console.error("Error playing audio:", e)
        }
      })

      async function playAudio(audioUrl) {
        try {
          if (audioUrl) {
            const audio = new Audio(audioUrl)
            await audio.play()
          } else {
            console.error("Invalid audio URL")
          }
        } catch (error) {
          console.error("Error creating audio element:", error)
        }
      }
    </script>
  </body>
</html>
